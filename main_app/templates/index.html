<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"/>
    <title>Weather map</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/libs/leaflet.css') }}"/>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/libs/leaflet.groupedlayercontrol.css') }}"/>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/custom.css') }}"/>
    <script src="{{ url_for('static', filename='js/libs/leaflet.js') }}"></script>
    <script src="{{ url_for('static', filename='js/libs/jquery-core.js') }}"></script>
    <script src="{{ url_for('static', filename='js/libs/jquery-ui.js') }}"></script>
    <script src="{{ url_for('static', filename='js/libs/leaflet.groupedlayercontrol.js') }}"></script>

</head>
<body>
<div id="map" style="width: 100%; height: 100%; position: absolute"></div>
<script type="text/javascript">
    // var myIcon = L.icon({
    //     iconUrl: 'leaflet-marker-icon leaflet-zoom-animated leaflet-clickabl',
    //     iconSize: [32, 37],
    //     iconAnchor: [16, 37],
    //     popupAnchor: [0, -28]
    // });

    function onEachFeature(feature, layer) {
        layer.bindPopup(feature.properties.name);
    }

    var showCategory = function (geoJson) {

        L.geoJSON(geoJson, {
            pointToLayer: function (feature, latlng) {
                return L.marker(latlng);
            },
            onEachFeature: onEachFeature
        }).addTo(map);
    };
    var getCategory = function (id) {
        var data = {'category_id': id};
        $.post("/get_data_by_category", data = data, function (response_data, status) {
            showCategory(response_data)
        });
    };

    var natural_hazard_catageroies = {{ categories|safe }};
    var natural_hazard_catageroies_colors = {{ categories_colors|safe }};
    var showLegend = function (input_object) {
        data = getCategory(input_object.id);

    };
    var osmUrl = 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
        osmAttribution =
            'Map data <a target="_blank" href="http://www.openstreetmap.org">OpenStreetMap.org</a> contributors, ' +
            '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',
        osmLayer = new L.TileLayer(osmUrl, {
            maxZoom: 18,
            transparent: true,
            attribution: osmAttribution
        }),
        baseMaps = {
            "OpenStreetMap": osmLayer
        },

        fires_viirs_24 = L.tileLayer.wms("https://firms.modaps.eosdis.nasa.gov/wms/?", {
            layers: 'fires_viirs_24',
            format: 'image/png',
            transparent: true,
            attribution: "'NASA FIRMS WMS Service'"
        }),

        fires_viirs_48 = L.tileLayer.wms("https://firms.modaps.eosdis.nasa.gov/wms/?", {
            layers: 'fires_viirs_48',
            format: 'image/png',
            transparent: true,
            attribution: "'NASA FIRMS WMS Service'"
        }),

        fires_viirs_72 = L.tileLayer.wms("https://firms.modaps.eosdis.nasa.gov/wms/?", {
            layers: 'fires_viirs_72',
            format: 'image/png',
            transparent: true,
            attribution: "'NASA FIRMS WMS Service'"
        }),

        fires_viirs_7 = L.tileLayer.wms("https://firms.modaps.eosdis.nasa.gov/wms/?", {
            layers: 'fires_viirs_7',
            format: 'image/png',
            transparent: true,
            attribution: "'NASA FIRMS WMS Service'"
        }),
        groupedOverlays = {
            "VIIRS Fire/Hotspot": {
                "Fire Radar last 24 hours": fires_viirs_24,
                "Fire Radar last 48 hours": fires_viirs_48,
                "Fire Radar last 72 hours": fires_viirs_72,
                "Fire Radar last 7 days": fires_viirs_7,
            }
        },
        map = new L.Map('map', {
            center: new L.LatLng(40.7, -73.9),
            zoom: 7,
            layers: [osmLayer]
        });
    map.addControl(L.control.groupedLayers(baseMaps, groupedOverlays));

    // generate legend
    var legend = L.control({position: 'bottomleft'});
    legend.onAdd = function (map) {

        var div = L.DomUtil.create('div', 'leaflet-control-layers leaflet-control info legend'),
            labels = ['<strong>Categories</strong>'],
            categories = Object.keys(natural_hazard_catageroies);

        for (var i = 0; i < categories.length; i++) {

            div.innerHTML += labels.push(
                '<input type="checkbox" class="leaflet-control-layers-selector" id="' +
                natural_hazard_catageroies[categories[i]] +
                '" onchange="showLegend(this)">' +
                '<i class="circle" style="background:' +
                natural_hazard_catageroies_colors[categories[i]] +
                '"></i> ' +
                (categories[i] ? categories[i] : '+')
            );

        }
        div.innerHTML = labels.join('<br>');
        return div;
    };
    legend.addTo(map);

</script>
</body>
</html>